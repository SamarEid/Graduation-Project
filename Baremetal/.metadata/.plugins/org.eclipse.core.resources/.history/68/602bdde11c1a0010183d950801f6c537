/*
 * ultraSonic.h
 *
 *  Created on: ??þ/??þ/????
 *      Author: ASHRY
 */
#ifndef PERCEPTION_HAL_ULTRASONIC_H_
#define PERCEPTION_HAL_ULTRASONIC_H_

#define SOUND_SPEED  				(uint8_t)340
#define TIMER_FREQUENCY 			16000000
#define TRIGGER_FREQUENCY 			1
#define TICK_FREQUENCY 				10000
#define PWM_HIGH_TIME				0.5
#define PWM_FULL_TIME				1.0
#define DIGITAL_FILTER				0x0
#define FIRST_CAPTURE				(uint8_t)0
#define SECOND_CAPTURE				(uint8_t)1
#define TRIGGER_CHANNEL_1 			TIM_CHANNEL_1
#define TRIGGER_CHANNEL_2 			TIM_CHANNEL_2
#define TRIGGER_CHANNEL_3 			TIM_CHANNEL_3
#define TRIGGER_CHANNEL_4 			TIM_CHANNEL_4
#define ECHO_CHANNEL 				TIM_CHANNEL_1
#define IT_CC_CHANNEL				TIM_IT_CC1
#define GET_PSC()					(uint16_t)(((TIMER_FREQUENCY)/(TICK_FREQUENCY))-1)
#define GET_ARR()   				(uint32_t)(((PWM_HIGH_TIME)*(TICK_FREQUENCY))-1)
#define GET_RESET_VALUE()			(uint32_t)(((PWM_FULL_TIME)*(TICK_FREQUENCY))-1)
#define ECHO_PRIORITY				6

typedef struct {
	GPIO_TypeDef* GPIOxTrigger;
	GPIO_TypeDef* GPIOxEcho;
	uint32_t GPIOxTriggerPin;
	uint32_t GPIOxEchoPin;
	uint8_t GPIOxTriggerPinAF;
	uint8_t GPIOxEchoPinAF;
	TIM_HandleTypeDef* htimTrigger;
	TIM_HandleTypeDef* htimEcho;
	uint32_t TIMxTrigger_Channel;
	IRQn_Type EchoIRQ;
} ultraSonicInitTypeDef;

void ultraSonicVidInit(ultraSonicInitTypeDef*);
void ultraSonicVidStart(ultraSonicInitTypeDef*);
void ultraSonicInputCaptureHandler(TIM_HandleTypeDef*, uint32_t*, uint32_t*, float*, uint8_t*);
float ultraSonicFloatGetDistance(uint32_t*, uint32_t*);
void ultraSonicCheckOverFlow(TIM_HandleTypeDef*, uint8_t*);

#endif /* PERCEPTION_HAL_ULTRASONIC_H_ */
